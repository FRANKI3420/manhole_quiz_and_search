<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒãƒ³ãƒ›ãƒ¼ãƒ«å›³é‘‘ - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #121212;
            color: #eee;
        }

        header {
            background: #1f1f1f;
            padding: 20px 15px;
            /* ä¸Šä¸‹ã«å°‘ã—ä½™è£•ã‚’ */
            text-align: center;
            border-bottom: 2px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚¢ãƒƒãƒ— */
        header div[style*="font-size:16px"] {
            font-size: 20px !important;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        /* é€²æ—ãƒãƒ¼ã®èƒŒæ™¯ã‚’å°‘ã—å¤ªãã€è¦‹ã‚„ã™ã */
        .progress-bar-bg {
            background: #333;
            height: 12px;
            /* å°‘ã—å¤ªã */
            border-radius: 6px;
            width: 90%;
            margin: 12px auto;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* åé›†æ¸ˆã¿ãƒ»é”æˆç‡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .stats-text {
            font-size: 16px;
            /* 12pxã‹ã‚‰å¤§å¹…ã‚¢ãƒƒãƒ— */
            color: #eee;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* é”æˆç‡ãƒãƒƒã‚¸ã®è£…é£¾ */
        .rate-badge {
            background: #4dabff;
            color: white;
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* åˆ†æ¯ã®æ•°å­—ã‚’å°‘ã—æ§ãˆã‚ã« */
        #totalCount {
            color: #888;
            font-size: 0.9em;
        }

        #totalProgress {
            background: #4dabff;
            height: 100%;
            width: 0%;
            transition: width 0.5s;
        }

        .stats-text {
            font-size: 12px;
            color: #aaa;
        }

        /* æ“ä½œã‚¨ãƒªã‚¢ */
        .control-panel {
            background: #1f1f1f;
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        .select-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        select {
            flex: 1;
            height: 40px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 6px;
            font-size: 14px;
            padding: 0 5px;
        }

        .backup-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .btn-utility {
            background: none;
            border: 1px solid #555;
            color: #888;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆè¡¨ç¤º */
        #collectionList {
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .card-container {
            width: 31%;
            margin-bottom: 15px;
            background: #222;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        /* ç”»åƒã®å…¨ä½“è¡¨ç¤ºè¨­å®š */
        .card-container img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: contain;
            /* ç”»åƒã‚’æ å†…ã«åã‚ã‚‹ */
            filter: grayscale(100%) brightness(30%);
        }

        .card-container.collected img {
            filter: grayscale(0%) brightness(100%);
        }

        /* ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’å¼·åŒ– */
        .card-info {
            font-size: 13px;
            /* ã‚µã‚¤ã‚ºã‚¢ãƒƒãƒ— */
            font-weight: bold;
            /* å¤ªå­—ã§èª­ã¿ã‚„ã™ã */
            text-align: center;
            padding: 8px 2px;
            /* ä¸Šä¸‹ã«ä½™è£•ã‚’æŒãŸã›ã‚‹ */
            background: #272729;
            color: #eee;
            /* å°‘ã—æ˜ã‚‹ã„ç™½ã« */
            white-space: nowrap;
            /* æ”¹è¡Œã•ã›ãªã„ */
            overflow: hidden;
            /* ã¯ã¿å‡ºã—ã‚’éš ã™ */
            text-overflow: ellipsis;
            /* é•·ã„åå‰ã¯ã€Œ...ã€ã«ã™ã‚‹ */
            border-top: 1px solid #444;
        }

        /* é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‰²ã‚’å¤‰ãˆã‚‹ï¼ˆã•ã‚‰ã«åˆ†ã‹ã‚Šã‚„ã™ãï¼‰ */
        .selecting-active .card-info {
            background: #28a745;
            /* èƒŒæ™¯ã‚’ç·‘ã« */
            color: white;
        }

        /* ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®ã‚µã‚¤ã‚ºæ„Ÿã‚’å°‘ã—èª¿æ•´ï¼ˆ3åˆ—è¡¨ç¤ºã‚’ç¶­æŒã—ã¤ã¤ä½™ç™½ã‚’æœ€é©åŒ–ï¼‰ */
        .card-container {
            width: 31%;
            margin-bottom: 12px;
            background: #222;
            border-radius: 8px;
            /* è§’ã‚’å°‘ã—ä¸¸ã */
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* å–å¾—ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ */
        .check-mark {
            position: absolute;
            top: 3px;
            right: 3px;
            background: #4dabff;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 5;
        }

        .collected .check-mark {
            display: flex;
        }

        .empty-state {
            width: 100%;
            text-align: center;
            padding: 80px 0;
            color: #555;
            font-size: 14px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–æ ï¼šã“ã“ã‚’flexã«ã™ã‚‹ã®ãŒé‡è¦ */
        #modal {
            display: none;
            /* JSã§flexã«åˆ‡ã‚Šæ›¿ãˆã‚‹ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å´ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„è¨­å®š */
        .modal-content {
            background: #1a1a1a;
            width: 100%;
            height: 100%;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
            box-sizing: border-box;
        }

        /* ç”»åƒï¼šä½™ç™½ã‚’è‡ªå‹•ã§åŸ‹ã‚ã‚‹è¨­å®š */
        .modal-img {
            flex-grow: 1;
            /* ã“ã‚Œã§ç”»åƒãŒä½™ç™½åˆ†å¤§ãããªã‚‹ */
            min-height: 0;
            /* é‡è¦ï¼šflexå†…ã§ã®ç¸®å°ã‚’è¨±å¯ã™ã‚‹ */
            width: 100%;
            object-fit: contain;
            background: #000;
            border-radius: 8px;
        }

        .date-input {
            width: 80%;
            padding: 8px;
            margin: 10px 0;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
        }

        .btn-main {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* é¸æŠãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-container.selecting {
            border: 2px solid #4dabff;
            transform: scale(0.95);
        }

        /* é¸æŠç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®æ“¬ä¼¼è¡¨ç¤º */
        .select-overlay {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #fff;
            border-radius: 4px;
            z-index: 10;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .selection-active .select-overlay {
            display: flex;
        }

        .card-container.selected-for-bulk .select-overlay {
            background: #28a745;
            border-color: #28a745;
        }

        .card-container.selected-for-bulk .select-overlay::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
        }

        /* ã‚«ãƒ¼ãƒ‰ã®ãƒ™ãƒ¼ã‚¹è¨­å®š */
        .card-container {
            position: relative;
            background: #222;
            /* ç”»åƒãŒãªã„æ™‚ã®èƒŒæ™¯è‰² */
            min-height: 100px;
            /* ç”»åƒãŒãªãã¦ã‚‚é«˜ã•ã‚’ç¢ºä¿ */
        }

        /* é¸æŠä¸­ï¼ˆç·‘æ ï¼‹æš—ãã™ã‚‹ï¼‰ */
        .card-container.selecting-active {
            outline: 4px solid #28a745 !important;
            outline-offset: -4px;
        }

        /* é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã«é‡ãªã‚‹åŠé€æ˜ã®è†œ */
        .card-container.selecting-active::after {
            content: "é¸æŠä¸­";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(40, 167, 69, 0.3);
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        /* ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å¿œ */
        .card-container img {
            min-height: 80px;
            background: #333;
        }

        #filterStats {
            padding: 12px;
            background: #1a1a1a;
            text-align: center;
            font-size: 14px;
            /* å°‘ã—å¤§ãã */
            color: #4dabff;
            border-bottom: 2px solid #333;
            display: none;
            line-height: 1.6;
        }

        #filterStats b {
            color: #fff;
            /* æ•°å­—ã‚’ç™½ãã—ã¦å¼·èª¿ */
            font-size: 16px;
        }
    </style>
</head>

<body>
    <header>
        <div style="font-weight:bold;">ãƒãƒ³ãƒ›ãƒ¼ãƒ«å›³é‘‘</div>
        <div class="progress-bar-bg">
            <div id="totalProgress"></div>
        </div>
        <div class="stats-text">
        </div>
    </header>

    <div class="control-panel">
        <div class="select-group">
            <select id="prefFilter" onchange="renderCollection()">
                <option value="">éƒ½é“åºœçœŒã§çµã‚Šè¾¼ã‚€</option>
            </select>
            <select id="editionFilter" onchange="renderCollection()">
                <option value="">å¼¾æ•°ã§çµã‚Šè¾¼ã‚€</option>
            </select>
        </div>
        <div id="filterStats"
            style="padding: 10px; background: #222; text-align: center; font-size: 13px; color: #4dabff; border-bottom: 1px solid #333; display: none;">
            è¡¨ç¤ºä¸­: <span id="currentFilteredCount">0</span>æš ï¼ˆå–å¾—æ¸ˆã¿: <span id="currentCollectedInFilter">0</span>æšï¼‰
        </div>
        <div id="selectionModeArea" style="text-align: center; margin: 10px 0; display:none;">
            <button id="selectModeBtn" class="btn-utility" onclick="toggleSelectionMode()"
                style="background: #444; color: white; width: 45%;">é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
            <button id="executeBulkBtn" class="btn-main" onclick="executeSelectedCollect()"
                style="display:none; background: #28a745; width: 45%; margin:0; padding: 8px;">é¸æŠåˆ†ã‚’ç™»éŒ²</button>
        </div>
        <div id="bulkActionArea" style="display:none; margin: 10px 0;">
            <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 10px;">
                <button id="selectAllBtn" class="btn-utility" onclick="selectAllFiltered()"
                    style="flex: 1; display: none; background: #444;">
                    è¡¨ç¤ºä¸­ã‚’ã™ã¹ã¦é¸æŠ
                </button>
                <button id="bulkCollectBtn" class="btn-main" style="flex: 2;">
                    ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ç™»éŒ²
                </button>
            </div>
        </div>

    </div>

    <div id="collectionList">
        <div class="empty-state">éƒ½é“åºœçœŒã‹å¼¾æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    </div>

    <div id="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">

            <div
                style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span onclick="closeModal()" style="font-size: 28px; color: #888; cursor: pointer;">âœ•</span>
                <span id="modalTitle" style="font-size: 20px; font-weight: bold; color: #fff;"></span>
                <span style="width: 28px;"></span>
            </div>

            <img id="modalImg" src="" class="modal-img">

            <div style="flex-shrink: 0; text-align: center; margin: 10px 0;">
                <p id="modalSub" style="color: #888; font-size: 13px; margin-bottom: 8px;"></p>
                <button id="customSearchBtn" class="btn-main" onclick="goToSearchPage()"
                    style="width: 70%; background: #444; color: #fff; padding: 8px; font-size: 13px; border-radius: 6px; margin: 0 auto; display: block;">
                    ğŸ” ç”»åƒã§åˆ¤å®šãƒ»æ¤œç´¢
                </button>
            </div>

            <div
                style="flex-shrink: 0; background: #222; padding: 12px; border-radius: 10px; display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size: 11px; color: #4dabff;">å–å¾—æ—¥</label>
                    <input type="date" id="collectDate" class="date-input" style="width: 60%; margin: 0; padding: 5px;">
                </div>

                <button id="getBtn" class="btn-main" onclick="toggleCollect()"
                    style="margin: 0; padding: 12px; font-size: 16px;"></button>

                <div style="display: flex; gap: 8px;">
                    <button id="deleteBtn" onclick="deleteCollect()"
                        style="flex: 1; background: none; color: #ff4d4d; border: 1px solid #ff4d4d44; font-size: 12px; padding: 8px; border-radius: 6px; display: none;">å‰Šé™¤</button>
                    <button onclick="closeModal()" class="btn-utility"
                        style="flex: 2; background: #333; color: #ccc; border: 1px solid #444; font-size: 14px; padding: 8px;">ä¸€è¦§ã«æˆ»ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let masterData = [];
        let userStats = JSON.parse(localStorage.getItem('manhole_collection')) || {};
        let isSelectionMode = false; // é¸æŠãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        let selectedCities = new Set(); // é¸æŠä¸­ãƒªã‚¹ãƒˆ

        const prefOrder = ["ä¸–ç•Œ", "ãã®ä»–", "åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å®®åŸçœŒ", "ç§‹ç”°çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ", "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ", "æ–°æ½ŸçœŒ", "å¯Œå±±çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ", "é™å²¡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å…µåº«çœŒ", "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "é³¥å–çœŒ", "å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ", "å¾³å³¶çœŒ", "é¦™å·çœŒ", "æ„›åª›çœŒ", "é«˜çŸ¥çœŒ", "ç¦å²¡çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ", "ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "æ²–ç¸„çœŒ"];

        fetch('master_data.json').then(res => res.json()).then(data => {
            masterData = data;
            updateStats();
            initFilters();
        });

        function updateStats() {
            const total = masterData.length;
            const collected = Object.keys(userStats).filter(k => userStats[k].collected).length;
            const rate = total > 0 ? Math.round((collected / total) * 100) : 0;

            // æ•°å€¤ã‚’æ›´æ–°
            const statsText = document.querySelector('.stats-text');
            statsText.innerHTML = `
        <span>
            <span id="collectedCount" style="font-size: 1.2em; color: #4dabff;">${collected}</span> 
            <span style="color: #888;">/</span> 
            <span id="totalCount">${total}</span> 
            <small style="font-weight: normal; margin-left: 4px;">åé›†æ¸ˆã¿</small>
        </span>
        <span class="rate-badge">é”æˆç‡: ${rate}%</span>
    `;

            // ãƒãƒ¼ã‚’æ›´æ–°
            const progressBar = document.getElementById('totalProgress');
            if (progressBar) {
                progressBar.style.width = rate + '%';
            }
        }

        function goToSearchPage() {
            if (!currentCity) return;
            const d = masterData.find(x => x.city === currentCity);
            if (!d || !d.url) return;

            /**
             * search.htmlã¸é·ç§»ã—ã¾ã™ã€‚
             * ç”»åƒURLã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™ã“ã¨ã§ã€ç§»å‹•å…ˆã§è‡ªå‹•çš„ã«ãã®ç”»åƒã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚
             */
            const targetUrl = `search.html?img=${encodeURIComponent(d.url)}&city=${encodeURIComponent(d.city)}`;
            window.open(targetUrl, '_blank'); // åˆ¥ã‚¿ãƒ–ã§é–‹ãå ´åˆ
            // window.location.href = targetUrl; // åŒã˜ã‚¿ãƒ–ã§ç§»å‹•ã™ã‚‹å ´åˆ
        }
        function initFilters() {
            const pSel = document.getElementById('prefFilter');
            prefOrder.forEach(p => pSel.innerHTML += `<option value="${p}">${p}</option>`);

            const eSel = document.getElementById('editionFilter');
            const eds = [...new Set(masterData.map(d => d.edition))].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            eds.forEach(e => eSel.innerHTML += `<option value="${e}">${e}</option>`);
        }

        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            const selectAllBtn = document.getElementById('selectAllBtn');

            if (!isSelectionMode) {
                selectedCities.clear();
            }

            // é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã¿ã€Œã™ã¹ã¦é¸æŠã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            if (selectAllBtn) {
                selectAllBtn.style.display = isSelectionMode ? 'block' : 'none';
            }

            renderCollection();
        }

        function selectAllFiltered() {
            // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã§çµã‚Šè¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const pref = document.getElementById('prefFilter').value;
            const ed = document.getElementById('editionFilter').value;

            let filtered = masterData;
            if (pref) filtered = filtered.filter(d => d.pref === pref);
            if (ed) filtered = filtered.filter(d => d.edition === ed);

            // æœªå–å¾—ã®ã‚‚ã®ã ã‘ã‚’æŠ½å‡º
            const uncollectedInFilter = filtered.filter(c => !userStats[c.city]?.collected);

            // å…¨é¸æŠã‹å…¨è§£é™¤ã‹ã‚’åˆ¤å®šï¼ˆã™ã§ã«å…¨ã¦é¸æŠæ¸ˆã¿ãªã‚‰è§£é™¤ã€ãã†ã§ãªã‘ã‚Œã°å…¨é¸æŠï¼‰
            const allSelected = uncollectedInFilter.every(c => selectedCities.has(c.city));

            if (allSelected) {
                // ã™ã§ã«å…¨é¸æŠçŠ¶æ…‹ãªã‚‰ã€ã“ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å†…ã®é¸æŠã‚’è§£é™¤
                uncollectedInFilter.forEach(c => selectedCities.delete(c.city));
            } else {
                // æœªé¸æŠãŒå«ã¾ã‚Œã‚‹ãªã‚‰ã€ã™ã¹ã¦é¸æŠã«è¿½åŠ 
                uncollectedInFilter.forEach(c => selectedCities.add(c.city));
            }

            renderCollection();
        }

        function renderCollection() {
            const pref = document.getElementById('prefFilter').value;
            const ed = document.getElementById('editionFilter').value;
            const listDiv = document.getElementById('collectionList');
            const bulkArea = document.getElementById('bulkActionArea');
            const bulkBtn = document.getElementById('bulkCollectBtn');
            const statsDiv = document.getElementById('filterStats'); // å–å¾—ç‡è¡¨ç¤ºç”¨

            if (!pref && !ed) {
                listDiv.innerHTML = '<div class="empty-state">éƒ½é“åºœçœŒã‹å¼¾æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                bulkArea.style.display = 'none';
                if (statsDiv) statsDiv.style.display = 'none';
                return;
            }

            let filtered = masterData;
            if (pref) filtered = filtered.filter(d => d.pref === pref);
            if (ed) filtered = filtered.filter(d => d.edition === ed);

            // --- è¿½åŠ ï¼šå–å¾—ç‡ã®è¨ˆç®—ã¨è¡¨ç¤º ---
            if (statsDiv) {
                const totalInFilter = filtered.length;
                const collectedInFilter = filtered.filter(c => userStats[c.city]?.collected).length;
                const rate = totalInFilter > 0 ? Math.round((collectedInFilter / totalInFilter) * 100) : 0;

                statsDiv.style.display = 'block';
                statsDiv.innerHTML = `
            è¡¨ç¤ºä¸­: <b>${totalInFilter}</b>æš / 
            å–å¾—æ¸ˆã¿: <b>${collectedInFilter}</b>æš 
            <span style="margin-left:8px; padding:2px 8px; background:#4dabff; color:white; border-radius:12px; font-size:12px; font-weight:bold;">
                é”æˆç‡: ${rate}%
            </span>
        `;
            }

            // é¸æŠãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’èª¿æ•´
            bulkArea.style.display = (filtered.length > 0) ? 'block' : 'none';
            if (isSelectionMode) {
                bulkBtn.onclick = executeBulkRegistration;
                bulkBtn.textContent = selectedCities.size > 0 ? `${selectedCities.size}æšã‚’ç™»éŒ²ã™ã‚‹` : "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦æˆ»ã‚‹";
                if (selectedCities.size === 0) {
                    bulkBtn.onclick = toggleSelectionMode;
                }
            } else {
                bulkBtn.onclick = toggleSelectionMode;
                bulkBtn.textContent = "ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ç™»éŒ²";
            }

            listDiv.innerHTML = filtered.map(c => {
                const isCollected = userStats[c.city]?.collected;
                const isSelected = selectedCities.has(c.city);

                // çŠ¶æ…‹ã«ã‚ˆã‚‹ã‚¯ãƒ©ã‚¹åˆ†ã‘
                let statusClass = isCollected ? 'collected' : '';
                if (isSelectionMode && isSelected) statusClass = 'selecting-active';

                return `
            <div class="card-container ${statusClass}" onclick="handleCardClick('${c.city.replace(/'/g, "\\'")}')">
                <div class="check-mark">âœ“</div>
                
                ${isSelectionMode && !isCollected ? `
                    <div class="select-dot ${isSelected ? 'dot-active' : ''}"></div>` : ''}

                <img src="${c.url}" loading="lazy" alt="${c.city}">
                
                <div class="card-info">${c.city}</div>
            </div>
        `;
            }).join('');
        }

        // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ
        function handleCardClick(city) {
            if (isSelectionMode) {
                // ã™ã§ã«æŒã£ã¦ã„ã‚‹ã‚‚ã®ã¯é¸æŠä¸å¯
                if (userStats[city]?.collected) return;

                if (selectedCities.has(city)) {
                    selectedCities.delete(city);
                } else {
                    selectedCities.add(city);
                }
                renderCollection();
            } else {
                openModal(city);
            }
        }

        // é¸æŠã—ãŸã‚‚ã®ã‚’ä¸€æ‹¬ã§ä¿å­˜ï¼ˆæ—¥ä»˜ã‚’ç©ºã«ã™ã‚‹ä¿®æ­£ç‰ˆï¼‰
        function executeBulkRegistration() {
            if (selectedCities.size === 0) return;

            if (confirm(`${selectedCities.size}æšã‚’ä¸€æ‹¬ã§ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ—¥ä»˜ã¯æœªè¨­å®šã§ç™»éŒ²ã•ã‚Œã¾ã™ï¼‰`)) {
                selectedCities.forEach(city => {
                    // ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã®ã‚‚ã®ã¯ä¸Šæ›¸ãã—ãªã„ã€ã¾ãŸã¯æ–°è¦ç™»éŒ²
                    userStats[city] = {
                        collected: true,
                        date: "" // ã“ã“ã‚’ç©ºç™½ã«ã™ã‚‹
                    };
                });

                localStorage.setItem('manhole_collection', JSON.stringify(userStats));
                selectedCities.clear();
                isSelectionMode = false;
                updateStats();
                renderCollection();
                alert('ç™»éŒ²ã—ã¾ã—ãŸï¼');
            }
        }

        // --- ä»¥ä¸‹ã€æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡¦ç†ã¯ãã®ã¾ã¾ ---
        let currentCity = null;
        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç† ---
        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç† ---
        function openModal(c) {
            currentCity = c;
            const d = masterData.find(x => x.city === c);
            const saved = userStats[c] || { collected: false, date: "" };

            document.getElementById('modalImg').src = d.url;
            document.getElementById('modalTitle').textContent = d.city;
            document.getElementById('modalSub').textContent = `${d.pref} / ${d.edition}`;
            document.getElementById('collectDate').value = saved.date || "";

            const getBtn = document.getElementById('getBtn');
            const delBtn = document.getElementById('deleteBtn');

            if (saved.collected) {
                // å–å¾—æ¸ˆã¿ã®å ´åˆ
                getBtn.textContent = 'æ—¥ä»˜ã‚’æ›´æ–°ã—ã¦ä¿å­˜';
                getBtn.style.background = '#28a745';
                delBtn.style.display = 'block'; // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            } else {
                // æœªå–å¾—ã®å ´åˆ
                getBtn.textContent = 'å–å¾—æ¸ˆã¿ã«ã™ã‚‹';
                getBtn.style.background = '#4dabff';
                delBtn.style.display = 'none';  // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éš ã™
            }

            document.getElementById('modal').style.display = 'flex';
        }

        // --- å–å¾—ãƒ»æ›´æ–°å‡¦ç† ---
        function toggleCollect() {
            const dateVal = document.getElementById('collectDate').value;

            // æ–°è¦ã§ã‚‚æ›´æ–°ã§ã‚‚ã€ã“ã®å†…å®¹ã§ä¸Šæ›¸ãä¿å­˜
            userStats[currentCity] = {
                collected: true,
                date: dateVal
            };

            saveAndRefresh();
        }

        // --- ã€æ–°è¦è¿½åŠ ã€‘å‰Šé™¤å‡¦ç† ---
        function deleteCollect() {
            if (confirm(`${currentCity} ã®å–å¾—è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete userStats[currentCity];
                saveAndRefresh();
            }
        }

        // å…±é€šã®ä¿å­˜ãƒ»æ›´æ–°å‡¦ç†
        function saveAndRefresh() {
            localStorage.setItem('manhole_collection', JSON.stringify(userStats));
            updateStats();
            renderCollection();
            closeModal();
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function exportBackup() {
            const blob = new Blob([JSON.stringify(userStats, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `manhole_record_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('ç¾åœ¨ã®è¨˜éŒ²ã‚’ä¸Šæ›¸ãã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        userStats = data;
                        localStorage.setItem('manhole_collection', JSON.stringify(userStats));
                        updateStats();
                        renderCollection();
                        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
                    }
                } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); }
            };
            reader.readAsText(file);
        }
    </script>
</body>
<footer
    style="margin-top: 40px; padding: 30px 15px; border-top: 1px solid #333; text-align: center; background: #1a1a1a;">
    <div style="font-size: 12px; color: #666; margin-bottom: 15px;">ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆæ©Ÿç¨®å¤‰æ›´æ™‚ã®ç§»è¡Œãªã©ï¼‰</div>
    <div class="backup-row">
        <button class="btn-utility" onclick="exportBackup()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn-utility" onclick="document.getElementById('importFile').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <input type="file" id="importFile" style="display:none" onchange="importBackup(event)">
    </div>
    <div style="font-size: 10px; color: #444; margin-top: 20px;">Â© ãƒãƒ³ãƒ›ãƒ¼ãƒ«å›³é‘‘</div>
</footer>

</html>