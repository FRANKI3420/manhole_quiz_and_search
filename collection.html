<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒãƒ³ãƒ›ãƒ¼ãƒ«å›³é‘‘ - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #121212;
            color: #eee;
        }

        header {
            background: #1f1f1f;
            padding: 20px 15px;
            /* ä¸Šä¸‹ã«å°‘ã—ä½™è£•ã‚’ */
            text-align: center;
            border-bottom: 2px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚¢ãƒƒãƒ— */
        header div[style*="font-size:16px"] {
            font-size: 20px !important;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        /* é€²æ—ãƒãƒ¼ã®èƒŒæ™¯ã‚’å°‘ã—å¤ªãã€è¦‹ã‚„ã™ã */
        .progress-bar-bg {
            background: #333;
            height: 12px;
            /* å°‘ã—å¤ªã */
            border-radius: 6px;
            width: 90%;
            margin: 12px auto;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* åé›†æ¸ˆã¿ãƒ»é”æˆç‡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .stats-text {
            font-size: 16px;
            /* 12pxã‹ã‚‰å¤§å¹…ã‚¢ãƒƒãƒ— */
            color: #eee;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* é”æˆç‡ãƒãƒƒã‚¸ã®è£…é£¾ */
        .rate-badge {
            background: #4dabff;
            color: white;
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* åˆ†æ¯ã®æ•°å­—ã‚’å°‘ã—æ§ãˆã‚ã« */
        #totalCount {
            color: #888;
            font-size: 0.9em;
        }

        #totalProgress {
            background: #4dabff;
            height: 100%;
            width: 0%;
            transition: width 0.5s;
        }

        .stats-text {
            font-size: 12px;
            color: #aaa;
        }

        /* æ“ä½œã‚¨ãƒªã‚¢ */
        .control-panel {
            background: #1f1f1f;
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        .select-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        select {
            flex: 1;
            height: 40px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 6px;
            font-size: 14px;
            padding: 0 5px;
        }

        .backup-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .btn-utility {
            background: none;
            border: 1px solid #555;
            color: #888;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆè¡¨ç¤º */
        #collectionList {
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .card-container {
            content-visibility: auto;
            /* ç”»é¢å¤–ã®ã‚«ãƒ¼ãƒ‰ã®æç”»è² è·ã‚’ã‚«ãƒƒãƒˆ */
            contain-intrinsic-size: auto 147px;
            width: 31%;
            margin-bottom: 15px;
            background: #222;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        /* ç”»åƒã®å…¨ä½“è¡¨ç¤ºè¨­å®š */
        .card-container img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: contain;
            /* ç”»åƒã‚’æ å†…ã«åã‚ã‚‹ */
            filter: grayscale(100%) brightness(30%);
        }

        .card-container.collected img {
            filter: grayscale(0%) brightness(100%);
        }

        /* ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’å¼·åŒ– */
        .card-info {
            font-size: 13px;
            /* ã‚µã‚¤ã‚ºã‚¢ãƒƒãƒ— */
            font-weight: bold;
            /* å¤ªå­—ã§èª­ã¿ã‚„ã™ã */
            text-align: center;
            padding: 8px 2px;
            /* ä¸Šä¸‹ã«ä½™è£•ã‚’æŒãŸã›ã‚‹ */
            background: #272729;
            color: #eee;
            /* å°‘ã—æ˜ã‚‹ã„ç™½ã« */
            white-space: nowrap;
            /* æ”¹è¡Œã•ã›ãªã„ */
            overflow: hidden;
            /* ã¯ã¿å‡ºã—ã‚’éš ã™ */
            text-overflow: ellipsis;
            /* é•·ã„åå‰ã¯ã€Œ...ã€ã«ã™ã‚‹ */
            border-top: 1px solid #444;
        }

        /* é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‰²ã‚’å¤‰ãˆã‚‹ï¼ˆã•ã‚‰ã«åˆ†ã‹ã‚Šã‚„ã™ãï¼‰ */
        .selecting-active .card-info {
            background: #28a745;
            /* èƒŒæ™¯ã‚’ç·‘ã« */
            color: white;
        }

        /* ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®ã‚µã‚¤ã‚ºæ„Ÿã‚’å°‘ã—èª¿æ•´ï¼ˆ3åˆ—è¡¨ç¤ºã‚’ç¶­æŒã—ã¤ã¤ä½™ç™½ã‚’æœ€é©åŒ–ï¼‰ */
        .card-container {
            width: 31%;
            margin-bottom: 12px;
            background: #222;
            border-radius: 8px;
            /* è§’ã‚’å°‘ã—ä¸¸ã */
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* å–å¾—ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ */
        .check-mark {
            position: absolute;
            top: 3px;
            right: 3px;
            background: #4dabff;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 5;
        }

        .collected .check-mark {
            display: flex;
        }

        .empty-state {
            width: 100%;
            text-align: center;
            padding: 80px 0;
            color: #555;
            font-size: 14px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–æ ï¼šã“ã“ã‚’flexã«ã™ã‚‹ã®ãŒé‡è¦ */
        #modal {
            display: none;
            /* JSã§flexã«åˆ‡ã‚Šæ›¿ãˆã‚‹ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å´ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„è¨­å®š */
        .modal-content {
            background: #1a1a1a;
            width: 100%;
            height: 100%;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
            box-sizing: border-box;
        }

        /* ç”»åƒï¼šä½™ç™½ã‚’è‡ªå‹•ã§åŸ‹ã‚ã‚‹è¨­å®š */
        .modal-img {
            flex-grow: 1;
            /* ã“ã‚Œã§ç”»åƒãŒä½™ç™½åˆ†å¤§ãããªã‚‹ */
            min-height: 0;
            /* é‡è¦ï¼šflexå†…ã§ã®ç¸®å°ã‚’è¨±å¯ã™ã‚‹ */
            width: 100%;
            object-fit: contain;
            background: #000;
            border-radius: 8px;
        }

        .date-input {
            width: 80%;
            padding: 8px;
            margin: 10px 0;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
        }

        .btn-main {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* é¸æŠãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-container.selecting {
            border: 2px solid #4dabff;
            transform: scale(0.95);
        }

        /* é¸æŠç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®æ“¬ä¼¼è¡¨ç¤º */
        .select-overlay {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #fff;
            border-radius: 4px;
            z-index: 10;
            display: none;
            align-items: center;
            justify-content: center;
        }


        .selection-active .select-overlay {
            display: flex;
        }

        .card-container.selected-for-bulk .select-overlay {
            background: #28a745;
            border-color: #28a745;
        }

        .card-container.selected-for-bulk .select-overlay::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
        }

        /* ã‚«ãƒ¼ãƒ‰ã®ãƒ™ãƒ¼ã‚¹è¨­å®š */
        .card-container {
            position: relative;
            background: #222;
            /* ç”»åƒãŒãªã„æ™‚ã®èƒŒæ™¯è‰² */
            min-height: 100px;
            /* ç”»åƒãŒãªãã¦ã‚‚é«˜ã•ã‚’ç¢ºä¿ */
        }

        /* é¸æŠä¸­ï¼ˆç·‘æ ï¼‹æš—ãã™ã‚‹ï¼‰ */
        /* .card-container.selecting-active {
            outline: 4px solid #28a745 !important;
            outline-offset: -4px;
        } */

        /* é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã«é‡ãªã‚‹åŠé€æ˜ã®è†œ */
        .card-container.selecting-active::after {
            content: "é¸æŠä¸­";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(40, 167, 69, 0.3);
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        /* ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å¿œ */
        .card-container img {
            min-height: 80px;
            background: #333;
        }

        #filterStats {
            padding: 12px;
            background: #1a1a1a;
            text-align: center;
            font-size: 14px;
            /* å°‘ã—å¤§ãã */
            color: #4dabff;
            border-bottom: 2px solid #333;
            display: none;
            line-height: 1.6;
        }

        #filterStats b {
            color: #fff;
            /* æ•°å­—ã‚’ç™½ãã—ã¦å¼·èª¿ */
            font-size: 16px;
        }

        /* é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã«é¸ã‚“ã§ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®è¦‹ãŸç›® */
        .card-container.selecting-active {
            outline: 3px solid #4dabff;
            /* é’ã„æ ç·šã§å¼·èª¿ */
            transform: scale(0.98);
            /* å°‘ã—å‡¹ã¾ã›ã¦é¸æŠæ„Ÿã‚’å‡ºã™ */
            opacity: 1 !important;
            /* ç™»éŒ²æ¸ˆã¿ã§åŠé€æ˜ã«ãªã£ã¦ã„ã¦ã‚‚ã€é¸æŠä¸­ã¯ã‚¯ãƒƒã‚­ãƒªè¦‹ã›ã‚‹ */
        }

        /* æ—¥ä»˜æœªå…¥åŠ›ãƒãƒƒã‚¸ */
        .no-date-badge {
            position: absolute;
            bottom: 45px;
            /* ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®å°‘ã—ä¸Š */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 77, 77, 0.9);
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 5;
            pointer-events: none;
        }

        /* æ—¥ä»˜ç™»éŒ²ç‡ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #dateProgress {
            background: #ffc107;
            /* é»„è‰²ã£ã½ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
            height: 100%;
            width: 0%;
            transition: width 0.5s;
        }

        /* éƒ½é“åºœçœŒåˆ¥ã®çµ±è¨ˆã‚¨ãƒªã‚¢ */
        #prefStatsContainer {
            background: #222;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stats-title {
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }

        .pref-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
            max-height: 200px;
            /* å¢—ãˆã™ããŸæ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
            overflow-y: auto;
            padding-right: 5px;
        }

        .pref-item {
            font-size: 11px;
        }

        .pref-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            color: #ccc;
        }

        .bar-bg {
            background: #333;
            /* ãƒãƒ¼ã®èƒŒæ™¯ï¼ˆæœªå–å¾—åˆ†ï¼‰ */
            height: 8px;
            border-radius: 4px;
            margin-top: 4px;
        }

        .bar-fill {
            /* èƒŒæ™¯è‰²ã¯JSã§å‹•çš„ã«è¨­å®šã™ã‚‹ãŸã‚å‰Šé™¤ */
            height: 100%;
            border-radius: 4px;
            width: 0%;
            transition: width 0.8s ease-out, background-color 0.8s ease;
        }

        /* 100%ã®æ™‚ã®ç‰¹åˆ¥ãªå…‰ã¯æ®‹ã™ */
        .bar-complete {
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.6);
        }
    </style>
</head>

<body>
    <header>
        <div style="font-weight:bold;">ãƒãƒ³ãƒ›ãƒ¼ãƒ«å›³é‘‘</div>
        <div class="progress-bar-bg">
            <div id="totalProgress"></div>
        </div>
        <div class="progress-bar-bg" style="height: 4px; margin-top: -8px; opacity: 0.8;">
            <div id="dateProgress" style="background: #ffc107; height: 100%; width: 0%; transition: width 0.5s;"></div>
        </div>
        <div class="stats-text"></div>
    </header>

    <div class="control-panel">
        <div id="prefStatsContainer">
            <div class="stats-title">
                <span>éƒ½é“åºœçœŒåˆ¥ åˆ¶è¦‡ç‡</span>
                <small id="totalProgressText" style="color:#888;"></small>
            </div>
            <div id="prefStatsGrid" class="pref-grid">
            </div>
        </div>
        <div style="margin: 10px 0;">
            <input type="text" id="searchInput" placeholder="å¸‚ç”ºæ‘åã§æ¤œç´¢..." oninput="renderCollection()"
                style="width: 100%; padding: 12px; background: #222; color: white; border: 1px solid #444; border-radius: 8px; box-sizing: border-box; font-size: 16px;">
        </div>
        <div class="select-group">
            <select id="prefFilter" onchange="renderCollection()">
                <option value="">éƒ½é“åºœçœŒã§çµã‚Šè¾¼ã‚€</option>
            </select>
            <select id="editionFilter" onchange="renderCollection()">
                <option value="">å¼¾æ•°ã§çµã‚Šè¾¼ã‚€</option>
            </select>
        </div>
        <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 12px; align-items: center;">
            <a href="calender.html" style="
                                    display: inline-block;
                                    width: 80%;
                                    padding: 10px;
                                    background: #333;
                                    color: #4dabff;
                                    text-decoration: none;
                                    font-size: 14px;
                                    border: 1px solid #4dabff;
                                    border-radius: 8px;
                                    text-align: center;
                                    font-weight: bold;
                                ">ğŸ“… å–å¾—è¨˜éŒ²ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è¦‹ã‚‹</a>

            <a href="index.html" style="color: #888; text-decoration: none; font-size: 13px;">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
        </div>
        <div id="filterStats"
            style="padding: 10px; background: #222; text-align: center; font-size: 13px; color: #4dabff; border-bottom: 1px solid #333; display: none;">
            è¡¨ç¤ºä¸­: <span id="currentFilteredCount">0</span>æš ï¼ˆå–å¾—æ¸ˆã¿: <span id="currentCollectedInFilter">0</span>æšï¼‰
        </div>
        <div id="selectionModeArea" style="text-align: center; margin: 10px 0; display:none;">
            <button id="selectModeBtn" class="btn-utility" onclick="toggleSelectionMode()"
                style="background: #444; color: white; width: 45%;">é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
            <button id="executeBulkBtn" class="btn-main" onclick="executeSelectedCollect()"
                style="display:none; background: #28a745; width: 45%; margin:0; padding: 8px;">é¸æŠåˆ†ã‚’ç™»éŒ²</button>
        </div>
        <div id="bulkActionArea" style="display:none; margin: 10px 0;">
            <div id="bulkDateArea"
                style="display: none; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; background: #2a2a2a; padding: 8px; border-radius: 8px;">
                <label style="font-size: 12px; color: #4dabff; font-weight: bold;">ä¸€æ‹¬ç™»éŒ²æ—¥:</label>
                <input type="date" id="bulkDateInput"
                    style="padding: 5px; border-radius: 4px; border: 1px solid #444; background: #333; color: #fff; font-size: 14px;">
            </div>

            <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 10px;">
                <button id="selectAllBtn" class="btn-utility" onclick="selectAllFiltered()"
                    style="flex: 1; display: none; background: #444;">
                    è¡¨ç¤ºä¸­ã‚’ã™ã¹ã¦é¸æŠ
                </button>
                <button id="bulkCollectBtn" class="btn-main" style="flex: 2;">
                    ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ç™»éŒ²
                </button>
            </div>
        </div>

    </div>

    <div id="collectionList">
        <div class="empty-state">éƒ½é“åºœçœŒã‹å¼¾æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    </div>

    <div id="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">

            <div
                style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span onclick="closeModal()" style="font-size: 28px; color: #888; cursor: pointer;">âœ•</span>
                <span id="modalTitle" style="font-size: 20px; font-weight: bold; color: #fff;"></span>
                <span style="width: 28px;"></span>
            </div>

            <img id="modalImg" src="" class="modal-img">

            <div style="flex-shrink: 0; text-align: center; margin: 10px 0;">
                <p id="modalSub" style="color: #888; font-size: 13px; margin-bottom: 8px;"></p>
                <button id="customSearchBtn" class="btn-main" onclick="goToSearchPage()"
                    style="width: 70%; background: #444; color: #fff; padding: 8px; font-size: 13px; border-radius: 6px; margin: 0 auto; display: block;">
                    ğŸ” ç”»åƒã§åˆ¤å®šãƒ»æ¤œç´¢
                </button>
            </div>

            <div
                style="flex-shrink: 0; background: #222; padding: 12px; border-radius: 10px; display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size: 11px; color: #4dabff;">å–å¾—æ—¥</label>
                    <input type="date" id="collectDate" class="date-input" style="width: 60%; margin: 0; padding: 5px;">
                </div>

                <div style="margin-top:10px;">
                    <label style="font-size:12px; color:#aaa;">æ€ã„å‡ºãƒ¡ãƒ¢ï¼ˆä¸€è¡Œï¼‰</label>
                    <input type="text" id="memoInput" placeholder="ä¾‹ï¼šå®¶æ—æ—…è¡Œã§ç«‹ã¡å¯„ã£ãŸï¼"
                        style="width:100%; padding:8px; background:#333; color:white; border:1px solid #444; border-radius:4px; box-sizing:border-box;">
                </div>

                <button id="getBtn" class="btn-main" onclick="toggleCollect()"
                    style="margin: 0; padding: 12px; font-size: 16px;"></button>

                <div style="display: flex; gap: 8px;">
                    <button id="deleteBtn" onclick="deleteCollect()"
                        style="flex: 1; background: none; color: #ff4d4d; border: 1px solid #ff4d4d44; font-size: 12px; padding: 8px; border-radius: 6px; display: none;">å‰Šé™¤</button>
                    <button onclick="closeModal()" class="btn-utility"
                        style="flex: 2; background: #333; color: #ccc; border: 1px solid #444; font-size: 14px; padding: 8px;">ä¸€è¦§ã«æˆ»ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let masterData = [];
        let userStats = JSON.parse(localStorage.getItem('manhole_collection')) || {};
        let isSelectionMode = false;
        let selectedCities = new Set();
        let currentCity = null;

        const prefOrder = ["ä¸–ç•Œ", "ãã®ä»–", "åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å®®åŸçœŒ", "ç§‹ç”°çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ", "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ", "æ–°æ½ŸçœŒ", "å¯Œå±±çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ", "é™å²¡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å…µåº«çœŒ", "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "é³¥å–çœŒ", "å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ", "å¾³å³¶çœŒ", "é¦™å·çœŒ", "æ„›åª›çœŒ", "é«˜çŸ¥çœŒ", "ç¦å²¡çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ", "ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "æ²–ç¸„çœŒ"];

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        fetch('master_data.json').then(res => res.json()).then(data => {
            masterData = data;
            updateStats();
            initFilters();
            updatePrefStats();
        });

        // å…¨ä½“çµ±è¨ˆã®æ›´æ–°
        function updateStats() {
            const total = masterData.length;
            const collectedCards = Object.values(userStats).filter(s => s.collected);
            const collectedCount = collectedCards.length;
            const datedCount = collectedCards.filter(s => s.date && s.date !== "").length;

            const collectRate = total > 0 ? Math.round((collectedCount / total) * 100) : 0;
            const dateRate = collectedCount > 0 ? Math.round((datedCount / collectedCount) * 100) : 0;

            const statsText = document.querySelector('.stats-text');
            if (statsText) {
                statsText.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center; gap:2px;">
                            <div>
                                <span style="color: #4dabff; font-size: 1.1em;">${collectedCount}</span> / <span>${total}</span> 
                                <small>åé›†</small>
                                <span class="rate-badge" style="margin-left:8px;">åé›†ç‡: ${collectRate}%</span>
                            </div>
                            <div style="font-size: 11px; color: #ffc107; margin-top: 2px;">
                                æ—¥ä»˜ç™»éŒ²æ¸ˆã¿: ${datedCount}æš (ç™»éŒ²ç‡: ${dateRate}%)
                            </div>
                        </div>
                    `;
            }
            document.getElementById('totalProgress').style.width = collectRate + '%';
            document.getElementById('dateProgress').style.width = dateRate + '%';
        }

        function initFilters() {
            const pSel = document.getElementById('prefFilter');
            const eSel = document.getElementById('editionFilter');
            pSel.innerHTML = '<option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>';
            eSel.innerHTML = '<option value="">å¼¾æ•°ã‚’é¸æŠ</option>';

            prefOrder.forEach(p => {
                if (masterData.some(d => d.pref === p)) {
                    pSel.innerHTML += `<option value="${p}">${p}</option>`;
                }
            });

            const eds = [...new Set(masterData.map(d => d.edition))].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            eds.forEach(e => eSel.innerHTML += `<option value="${e}">${e}</option>`);
        }

        // é¸æŠãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼ˆç”»åƒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºç”Ÿã•ã›ãªã„ï¼‰
        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            if (!isSelectionMode) {
                selectedCities.clear();
            }
            renderCollection();
        }

        // è¡¨ç¤ºä¸­ã‚’ã™ã¹ã¦é¸æŠ
        function selectAllFiltered() {
            const pref = document.getElementById('prefFilter').value;
            const ed = document.getElementById('editionFilter').value;
            let filtered = masterData.filter(d => (!pref || d.pref === pref) && (!ed || d.edition === ed));

            const allSelected = filtered.every(c => selectedCities.has(c.city));
            filtered.forEach(c => {
                const el = document.querySelector(`[data-id="${c.id}"]`);
                if (allSelected) {
                    selectedCities.delete(c.city);
                    if (el) el.classList.remove('selecting-active');
                } else {
                    selectedCities.add(c.city);
                    if (el) el.classList.add('selecting-active');
                }
            });
            updateBulkButtonUI();
        }

        // ãƒ¡ã‚¤ãƒ³æç”»ï¼ˆã“ã“ã§ã®ã¿ç”»åƒãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç™ºç”Ÿï¼‰
        function renderCollection() {
            const pref = document.getElementById('prefFilter').value;
            const ed = document.getElementById('editionFilter').value;
            const listDiv = document.getElementById('collectionList');
            const bulkArea = document.getElementById('bulkActionArea');
            const statsDiv = document.getElementById('filterStats');
            const searchText = document.getElementById('searchInput').value.trim(); // â˜…è¿½åŠ 

            // â˜… æ¤œç´¢æ¡ä»¶ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–°
            // æ¤œç´¢æ–‡å­—ãŒã‚ã‚‹å ´åˆã¯ã€éƒ½é“åºœçœŒãƒ»å¼¾æ•°ãŒæœªé¸æŠã§ã‚‚è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
            if (!pref && !ed && !searchText) {
                listDiv.innerHTML = '<div class="empty-state">éƒ½é“åºœçœŒãƒ»å¼¾æ•°ã‚’é¸æŠã™ã‚‹ã‹ã€å¸‚ç”ºæ‘åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
                bulkArea.style.display = 'none';
                if (statsDiv) statsDiv.style.display = 'none';
                return;
            }

            let filtered = masterData.filter(d => {
                const pMatch = !pref || d.pref === pref;
                const eMatch = !ed || d.edition === ed;
                // â˜… å¸‚ç”ºæ‘åã«æ¤œç´¢æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹åˆ¤å®šï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰
                const sMatch = !searchText || d.city.toLowerCase().includes(searchText.toLowerCase());
                return pMatch && eMatch && sMatch;
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å†…çµ±è¨ˆ
            if (statsDiv) {
                const totalInFilter = filtered.length;
                const collectedInFilter = filtered.filter(c => userStats[c.city]?.collected);
                const collectedCount = collectedInFilter.length;
                const datedCountInFilter = collectedInFilter.filter(c => userStats[c.city]?.date).length;
                const dateRateInFilter = collectedCount > 0 ? Math.round((datedCountInFilter / collectedCount) * 100) : 0;
                const collectRateInFilter = totalInFilter > 0 ? Math.round((collectedCount / totalInFilter) * 100) : 0;

                statsDiv.style.display = 'block';
                statsDiv.innerHTML = `
                        <div style="margin-bottom: 5px;">
                            è¡¨ç¤ºä¸­: <b>${totalInFilter}</b>æš / å–å¾—æ¸ˆã¿: <b>${collectedCount}</b>æš 
                            <span class="rate-badge" style="margin-left:5px;">åé›†ç‡: ${collectRateInFilter}%</span>
                        </div>
                        <div style="font-size: 11px; color: #ffc107;">
                            è¡¨ç¤ºå†…ã®æ—¥ä»˜ç™»éŒ²: <b>${datedCountInFilter}</b>æš (ç™»éŒ²ç‡: ${dateRateInFilter}%)
                        </div>
                    `;
            }

            bulkArea.style.display = (filtered.length > 0) ? 'block' : 'none';
            updateBulkButtonUI();

            listDiv.innerHTML = filtered.map(c => {
                if (!c.url) return '';
                const stats = userStats[c.city];
                const isCollected = stats?.collected;
                const isSelected = selectedCities.has(c.city);
                const hasDate = stats?.date && stats.date !== "";
                const collectDateText = hasDate ? stats.date.replace(/-/g, '.') : (isCollected ? "æ—¥ä»˜æœªç™»éŒ²" : "");

                // â˜… ãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¡¨ç¤ºç”¨HTMLã‚’ä½œæˆï¼ˆã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« ellipsis æŒ‡å®šï¼‰
                const memoText = stats?.memo ?
                    `<div style="font-size:9px; color:#aaa; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; margin-top:2px;">${stats.memo}</div>`
                    : "";

                let statusClass = isCollected ? 'collected' : '';
                if (isSelectionMode && isSelected) statusClass = 'selecting-active';

                return `
                    <div class="card-container ${statusClass}" data-id="${c.id}" onclick="handleCardClick('${c.id}')">
                        <div class="check-mark">âœ“</div>
                        <img src="${c.url}" loading="lazy" alt="${c.city}" onerror="this.style.opacity='0.3';this.onerror=null;">
                        <div class="card-info">
                            <div style="font-weight:bold;">${c.city}</div>
                            ${memoText} <div class="date-text" style="font-size: 10px; color: ${hasDate ? '#4dabff' : '#ffc107'}; height: 12px; margin-top: 2px;">
                                ${collectDateText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¯ãƒ©ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆã®ã¿ã§å†æç”»ã—ãªã„ï¼‰
        function handleCardClick(cardId) {
            const cityData = masterData.find(d => d.id === cardId);
            if (!cityData) return;

            if (isSelectionMode) {
                const identifier = cityData.city;
                const cardElement = document.querySelector(`[data-id="${cardId}"]`);
                if (selectedCities.has(identifier)) {
                    selectedCities.delete(identifier);
                    if (cardElement) cardElement.classList.remove('selecting-active');
                } else {
                    selectedCities.add(identifier);
                    if (cardElement) cardElement.classList.add('selecting-active');
                }
                updateBulkButtonUI();
            } else {
                openModal(cardId);
            }
        }

        // UIãƒ‘ãƒ¼ãƒ„ã®ã¿æ›´æ–°
        function updateBulkButtonUI() {
            const bulkBtn = document.getElementById('bulkCollectBtn');
            const bulkDateArea = document.getElementById('bulkDateArea');
            const selectAllBtn = document.getElementById('selectAllBtn');

            if (isSelectionMode) {
                bulkBtn.onclick = executeBulkRegistration;
                bulkBtn.textContent = selectedCities.size > 0 ? `${selectedCities.size}æšã‚’ä¸€æ‹¬ç™»éŒ²ãƒ»æ›´æ–°` : "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
                if (selectAllBtn) selectAllBtn.style.display = 'block';
                if (bulkDateArea) bulkDateArea.style.display = (selectedCities.size > 0) ? 'flex' : 'none';
                if (selectedCities.size === 0) bulkBtn.onclick = toggleSelectionMode;
            } else {
                bulkBtn.onclick = toggleSelectionMode;
                bulkBtn.textContent = "ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ç™»éŒ²";
                if (selectAllBtn) selectAllBtn.style.display = 'none';
                if (bulkDateArea) bulkDateArea.style.display = 'none';
            }
        }

        function executeBulkRegistration() {
            if (selectedCities.size === 0) return;
            let targetDate = document.getElementById('bulkDateInput').value;
            const dateMsg = targetDate ? `${targetDate} ã§` : "æ—¥ä»˜ãªã—ã§";
            if (!confirm(`${selectedCities.size}æšã‚’ ${dateMsg}ä¸€æ‹¬ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            // executeBulkRegistration é–¢æ•°å†…ã®ãƒ«ãƒ¼ãƒ—éƒ¨åˆ†
            selectedCities.forEach(cityName => {
                // æ—¢å­˜ã®ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ç¶­æŒã—ã€ãªã‘ã‚Œã°ç©ºã«ã™ã‚‹
                const existingMemo = userStats[cityName]?.memo || "";
                userStats[cityName] = {
                    collected: true,
                    date: targetDate,
                    memo: existingMemo
                };
            });

            isSelectionMode = false;
            selectedCities.clear();
            saveAndRefresh();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¨ã
        function openModal(cardId) {
            const d = masterData.find(x => x.id === cardId);
            if (!d) return;
            currentCity = d.city;

            // userStatsã‹ã‚‰æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆmemoãŒãªã‘ã‚Œã°ç©ºæ–‡å­—ï¼‰
            const saved = userStats[d.city] || { collected: false, date: "", memo: "" };

            document.getElementById('modalImg').src = d.url;
            document.getElementById('modalTitle').textContent = d.city;
            document.getElementById('modalSub').textContent = `${d.pref} / ${d.edition}`;
            document.getElementById('collectDate').value = saved.date || "";

            // â˜…ãƒ¡ãƒ¢ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('memoInput').value = saved.memo || "";

            const getBtn = document.getElementById('getBtn');
            const delBtn = document.getElementById('deleteBtn');
            if (saved.collected) {
                getBtn.textContent = 'æ›´æ–°ã—ã¦ä¿å­˜';
                getBtn.style.background = '#28a745';
                delBtn.style.display = 'block';
            } else {
                getBtn.textContent = 'å–å¾—æ¸ˆã¿ã«ã™ã‚‹';
                getBtn.style.background = '#4dabff';
                delBtn.style.display = 'none';
            }
            document.getElementById('modal').style.display = 'flex';
        }

        // å–å¾—ãƒ»æ›´æ–°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
        function toggleCollect() {
            const dateVal = document.getElementById('collectDate').value;
            const memoVal = document.getElementById('memoInput').value; // â˜…ãƒ¡ãƒ¢ã‚’å–å¾—

            userStats[currentCity] = {
                collected: true,
                date: dateVal,
                memo: memoVal // â˜…ãƒ¡ãƒ¢ã‚’ä¿å­˜
            };
            saveAndRefresh();
        }

        function deleteCollect() {
            if (confirm(`${currentCity} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete userStats[currentCity];
                saveAndRefresh();
            }
        }

        function saveAndRefresh() {
            localStorage.setItem('manhole_collection', JSON.stringify(userStats));
            updateStats();
            renderCollection();
            closeModal();
            updatePrefStats(); // â˜…è¿½åŠ ï¼šéƒ½é“åºœçœŒåˆ¥çµ±è¨ˆã‚‚æ›´æ–°
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function goToSearchPage() {
            if (!currentCity) return;
            const d = masterData.find(x => x.city === currentCity);
            if (!d || !d.url) return;
            window.open(`search.html?img=${encodeURIComponent(d.url)}&city=${encodeURIComponent(d.city)}`, '_blank');
        }

        function exportBackup() {
            const blob = new Blob([JSON.stringify(userStats, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `manhole_record_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    userStats = JSON.parse(e.target.result);
                    localStorage.setItem('manhole_collection', JSON.stringify(userStats));
                    updateStats();
                    renderCollection();
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
                } catch (e) { alert('å½¢å¼ã‚¨ãƒ©ãƒ¼'); }
            };
            reader.readAsText(file);
        }

        function updatePrefStats() {
            const grid = document.getElementById('prefStatsGrid');
            const totalText = document.getElementById('totalProgressText');
            if (!grid || masterData.length === 0) return;

            // æ—¥æœ¬ã®æ¨™æº–çš„ãªéƒ½é“åºœçœŒé †ï¼ˆåŒ—æµ·é“ã€œæ²–ç¸„ï¼‰
            const prefOrder = [
                "ä¸–ç•Œ", "ãã®ä»–", "åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å®®åŸçœŒ", "ç§‹ç”°çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ",
                "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ",
                "æ–°æ½ŸçœŒ", "å¯Œå±±çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ",
                "é™å²¡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å…µåº«çœŒ",
                "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "é³¥å–çœŒ", "å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ",
                "å¾³å³¶çœŒ", "é¦™å·çœŒ", "æ„›åª›çœŒ", "é«˜çŸ¥çœŒ", "ç¦å²¡çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ",
                "ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "æ²–ç¸„çœŒ"
            ];

            const stats = {};
            masterData.forEach(card => {
                if (!stats[card.pref]) stats[card.pref] = { total: 0, collected: 0 };
                stats[card.pref].total++;
                const fullKey = `${card.city} (${card.id})`;
                if (userStats[fullKey]?.collected || userStats[card.city]?.collected) {
                    stats[card.pref].collected++;
                }
            });

            // å…¨ä½“é€²æ—ã®è¡¨ç¤º
            const allTotal = masterData.length;
            const allCollected = Object.values(userStats).filter(s => s.collected).length;
            totalText.textContent = `å…¨ä½“: ${allCollected} / ${allTotal} (${Math.floor((allCollected / allTotal) * 100) || 0}%)`;

            // éƒ½é“åºœçœŒé †ã«ä¸¦ã³æ›¿ãˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘æŠ½å‡ºï¼‰
            const sortedPrefs = prefOrder.filter(p => stats[p]);

            grid.innerHTML = sortedPrefs.map(pref => {
                const { total, collected } = stats[pref];
                const percent = Math.floor((collected / total) * 100);

                // â˜… å–å¾—ç‡ã«å¿œã˜ãŸã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è‰²ã‚’è¨ˆç®—
                // 0% (èµ¤ã£ã½ã„) -> 50% (é»„è‰²) -> 99% (ç·‘ã£ã½ã„)
                let barColor;
                if (collected === total) {
                    barColor = '#ffc107'; // 100%ã¯é‡‘
                } else {
                    // HSLè‰²ç©ºé–“ã‚’ä½¿ã£ã¦ã€è‰²ç›¸(Hue)ã‚’ 0(èµ¤)ã‹ã‚‰120(ç·‘)ã¾ã§å¤‰åŒ–ã•ã›ã‚‹
                    const hue = Math.floor(percent * 1.2);
                    barColor = `hsl(${hue}, 70%, 50%)`;
                }

                const completeClass = collected === total ? 'bar-complete' : '';

                return `
            <div class="pref-item">
                <div class="pref-info">
                    <span>${pref}</span>
                    <span>${collected}/${total}</span>
                </div>
                <div class="bar-bg">
                    <div class="bar-fill ${completeClass}" 
                         style="width: ${percent}%; background-color: ${barColor};">
                    </div>
                </div>
            </div>
        `;
            }).join('');
        }

    </script>
</body>
<footer
    style="margin-top: 40px; padding: 30px 15px; border-top: 1px solid #333; text-align: center; background: #1a1a1a;">
    <div style="font-size: 12px; color: #666; margin-bottom: 15px;">ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆæ©Ÿç¨®å¤‰æ›´æ™‚ã®ç§»è¡Œãªã©ï¼‰</div>
    <div class="backup-row">
        <button class="btn-utility" onclick="exportBackup()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn-utility" onclick="document.getElementById('importFile').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <input type="file" id="importFile" style="display:none" onchange="importBackup(event)">
    </div>
    <div style="font-size: 10px; color: #444; margin-top: 20px;">Â© ãƒãƒ³ãƒ›ãƒ¼ãƒ«å›³é‘‘</div>
</footer>

</html>