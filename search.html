<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>類似検索 & カラーパレット</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #121212;
            color: #eee;
            overflow-x: hidden;
        }

        h1 {
            font-size: 1.2rem;
            text-align: center;
            padding: 15px 0;
            background: #1f1f1f;
            margin: 0;
            border-bottom: 2px solid #333;
        }

        /* フィルターエリア */
        .selector-area {
            background: #1f1f1f;
            padding: 15px;
            border-bottom: 2px solid #444;
        }

        label {
            display: block;
            font-size: 13px;
            color: #4dabff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        select {
            width: 100%;
            height: 50px;
            font-size: 16px !important;
            margin-bottom: 12px;
            padding: 0 10px;
            border-radius: 8px;
            border: 1px solid #555;
            background: #333;
            color: #fff;
        }

        /* 表示コンテナ */
        h2 {
            font-size: 1rem;
            background: #333;
            margin: 0;
            padding: 10px 15px;
            border-left: 5px solid #4dabff;
        }

        /* メインカード表示 */
        #targetCard {
            width: 100%;
            background: #1f1f1f;
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #444;
        }

        #targetCard img {
            width: 80%;
            max-width: 320px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
        }

        .main-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-top: 15px;
        }

        .main-sub {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 15px;
        }

        /* おすすめエリア (2列) */
        #recommendResults {
            display: flex;
            flex-wrap: wrap;
            padding: 10px;
            justify-content: space-between;
        }

        .card {
            width: 48%;
            background: #272729;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .card img {
            width: 100%;
            height: auto;
            display: block;
        }

        .card-info {
            padding: 10px;
            text-align: center;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
        }

        .card-sub {
            font-size: 0.75rem;
            color: #bbb;
            margin-bottom: 8px;
        }

        /* カラーパレット */
        .palette-bar {
            display: flex;
            width: 90%;
            height: 25px;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 auto 5px auto;
            background: #444;
        }

        .color-chip {
            height: 100%;
        }

        .placeholder {
            text-align: center;
            padding: 50px 20px;
            color: #777;
        }

        .reset-btn {
            width: 100%;
            padding: 10px;
            background: none;
            border: none;
            color: #aaa;
            text-decoration: underline;
            font-size: 14px;
            cursor: pointer;
        }

        .card {
            width: 48%;
            background: #272729;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            /* 追加：指マークにする */
            transition: transform 0.2s, background-color 0.2s;
            /* 追加：アニメーション */
        }

        .card:active {
            transform: scale(0.95);
            /* 追加：タップした時に少し凹む演出 */
            background-color: #3a3a3c;
        }
    </style>
</head>

<body>

    <h1>類似マンホール検索</h1>

    <div class="selector-area">
        <label>都道府県</label>
        <select id="prefSelect"></select>

        <label>弾数</label>
        <select id="editionSelect"></select>

        <label>対象のカード</label>
        <select id="citySelect"></select>

        <button class="reset-btn" onclick="resetFilters()">条件をリセット</button>
        <div style="text-align: center; margin-top: 5px;">
            <a href="index.html" style="color: #4dabff; text-decoration: none; font-size: 14px;">← メニューに戻る</a>
        </div>
    </div>

    <div id="targetSection">
        <h2>選択したカード</h2>
        <div id="targetCardPlaceholder" class="placeholder">リストから選択してください</div>
        <div id="targetCard" style="display:none;"></div>
    </div>

    <div id="resultSection">
        <h2>似ているデザイン TOP10</h2>
        <div id="recommendPlaceholder" class="placeholder">ここに結果が表示されます</div>
        <div id="recommendResults"></div>
    </div>

    <script>
        let masterData = [];
        let similarityIndex = {};
        const prefOrder = ["世界", "その他", "北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県", "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県", "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県", "岐阜県", "静岡県", "愛知県", "三重県", "滋賀県", "京都府", "大阪府", "兵庫県", "奈良県", "和歌山県", "鳥取県", "島根県", "岡山県", "広島県", "山口県", "徳島県", "香川県", "愛媛県", "高知県", "福岡県", "佐賀県", "長崎県", "熊本県", "大分県", "宮崎縣", "鹿児島縣", "沖縄縣"];

        Promise.all([
            fetch('master_data.json').then(res => res.json()),
            fetch('similarity_index.json').then(res => res.json())
        ]).then(([data, index]) => {
            masterData = data;
            similarityIndex = index;
            updateFilters();
        });

        const prefSelect = document.getElementById('prefSelect');
        const editionSelect = document.getElementById('editionSelect');
        const citySelect = document.getElementById('citySelect');

        window.onload = () => {
            // 1. URLパラメータを取得
            const urlParams = new URLSearchParams(window.location.search);
            const targetCity = urlParams.get('city');

            if (targetCity) {
                // 2. セレクトボックス（citySelect）から該当する値を探してセット
                const citySelect = document.getElementById('citySelect');

                // データ読み込み完了を待つ必要があるため、データロード処理の中に組み込むのが理想
                const checkDataLoad = setInterval(() => {
                    if (masterData.length > 0) {
                        citySelect.value = targetCity;

                        // 3. 値が変わったことを通知して検索ロジックを発火させる
                        citySelect.dispatchEvent(new Event('change'));

                        clearInterval(checkDataLoad);
                    }
                }, 100);
            }
        };

        function updateFilters() {
            const selectedPref = prefSelect.value;
            const selectedEd = editionSelect.value;

            // 都道府県リストの更新（弾数フィルタ考慮）
            const rawPrefs = [...new Set(masterData.filter(d => !selectedEd || d.edition === selectedEd).map(d => d.pref))];
            const sortedPrefs = rawPrefs.sort((a, b) => prefOrder.indexOf(a) - prefOrder.indexOf(b));
            updateOptions(prefSelect, sortedPrefs, selectedPref, "すべての都道府県");

            // 弾数リストの更新（県フィルタ考慮）
            const currentEds = [...new Set(masterData.filter(d => !selectedPref || d.pref === selectedPref).map(d => d.edition))].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            updateOptions(editionSelect, currentEds, selectedEd, "すべての弾数");

            // 都市リストの更新
            const filteredCities = masterData.filter(d => (!selectedPref || d.pref === selectedPref) && (!selectedEd || d.edition === selectedEd));
            citySelect.innerHTML = '<option value="">カードを選択してください</option>';
            filteredCities.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.city;
                opt.textContent = `${item.city} (${item.edition})`;
                citySelect.appendChild(opt);
            });
        }

        function updateOptions(el, list, curr, def) {
            el.innerHTML = `<option value="">${def}</option>`;
            list.forEach(v => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = v;
                if (v === curr) opt.selected = true;
                el.appendChild(opt);
            });
        }

        function resetFilters() {
            prefSelect.value = ""; editionSelect.value = "";
            updateFilters();
            document.getElementById('targetCard').style.display = 'none';
            document.getElementById('targetCardPlaceholder').style.display = 'block';
            document.getElementById('recommendResults').innerHTML = '';
            document.getElementById('recommendPlaceholder').style.display = 'block';
        }

        function createPaletteHTML(palette) {
            if (!palette || palette.length === 0) return '';
            const chips = palette.map(c => `<div class="color-chip" style="background:${c.hex}; width:${c.ratio}%"></div>`).join('');
            return `<div class="palette-bar">${chips}</div>`;
        }

        prefSelect.onchange = updateFilters;
        editionSelect.onchange = updateFilters;

        citySelect.onchange = () => {
            const selectedId = citySelect.value;
            if (!selectedId) return;
            const targetData = masterData.find(item => item.city === selectedId);
            const similarIds = (similarityIndex[selectedId + ".png"] || []).slice(0, 10);

            // メイン表示
            document.getElementById('targetCardPlaceholder').style.display = 'none';
            const targetDiv = document.getElementById('targetCard');
            targetDiv.style.display = 'block';
            targetDiv.innerHTML = `
                <img src="${targetData.url}">
                <div class="main-title">${targetData.city}</div>
                <div class="main-sub">${targetData.pref} / ${targetData.edition}</div>
                ${createPaletteHTML(targetData.palette)}
            `;

            // おすすめ表示
            document.getElementById('recommendPlaceholder').style.display = 'none';
            const resultDiv = document.getElementById('recommendResults');
            resultDiv.innerHTML = '';
            similarIds.forEach(idWithExt => {
                const cityName = idWithExt.replace('.png', '');
                const d = masterData.find(item => item.city === cityName);
                if (d) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <img src="${d.url}">
                        <div class="card-info">
                            <div class="card-title">${d.city}</div>
                            <div class="card-sub">${d.pref}</div>
                            ${createPaletteHTML(d.palette)}
                        </div>`;
                    resultDiv.appendChild(card);
                }
            });
            targetDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        // --- 変更点：カード生成部分に onclick を追加 ---
        function createCardElement(d) {
            const card = document.createElement('div');
            card.className = 'card';
            // クリック時に selectCard 関数を呼ぶように設定
            card.onclick = () => selectCard(d.city);
            card.innerHTML = `
        <img src="${d.url}">
        <div class="card-info">
            <div class="card-title">${d.city}</div>
            <div class="card-sub">${d.pref}</div>
            ${createPaletteHTML(d.palette)}
        </div>`;
            return card;
        }

        // --- 新機能：カードを選択して再検索する関数 ---
        function selectCard(cityName) {
            // 1. フィルタをリセット（またはその都市が表示されるように調整）
            // 一番確実なのは、一旦すべての都市を選択肢に出してから選ぶこと
            resetFilters();

            // 2. セレクトボックスの値を書き換え
            citySelect.value = cityName;

            // 3. changeイベントを手動で実行
            citySelect.dispatchEvent(new Event('change'));

            // 4. 画面上部（メインカード）へスムーズにスクロール
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- 既存の citySelect.onchange 内のカード生成部分を差し替え ---
        citySelect.onchange = () => {
            const selectedId = citySelect.value;
            if (!selectedId) return;
            const targetData = masterData.find(item => item.city === selectedId);
            const similarIds = (similarityIndex[selectedId + ".png"] || []).slice(0, 10);

            // メイン表示
            document.getElementById('targetCardPlaceholder').style.display = 'none';
            const targetDiv = document.getElementById('targetCard');
            targetDiv.style.display = 'block';
            targetDiv.innerHTML = `
        <img src="${targetData.url}">
        <div class="main-title">${targetData.city}</div>
        <div class="main-sub">${targetData.pref} / ${targetData.edition}</div>
        ${createPaletteHTML(targetData.palette)}
    `;

            // おすすめ表示
            document.getElementById('recommendPlaceholder').style.display = 'none';
            const resultDiv = document.getElementById('recommendResults');
            resultDiv.innerHTML = '';

            similarIds.forEach(idWithExt => {
                const cityName = idWithExt.replace('.png', '');
                const d = masterData.find(item => item.city === cityName);
                if (d) {
                    // ここで共通化した関数を使用
                    const cardElement = createCardElement(d);
                    resultDiv.appendChild(cardElement);
                }
            });
        };
    </script>
</body>

</html>