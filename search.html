<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¡ä¼¼æ¤œç´¢ & ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #121212;
            color: #eee;
            overflow-x: hidden;
        }

        h1 {
            font-size: 1.2rem;
            text-align: center;
            padding: 15px 0;
            background: #1f1f1f;
            margin: 0;
            border-bottom: 2px solid #333;
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .selector-area {
            background: #1f1f1f;
            padding: 15px;
            border-bottom: 2px solid #444;
        }

        label {
            display: block;
            font-size: 13px;
            color: #4dabff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        select {
            width: 100%;
            height: 50px;
            font-size: 16px !important;
            margin-bottom: 12px;
            padding: 0 10px;
            border-radius: 8px;
            border: 1px solid #555;
            background: #333;
            color: #fff;
        }

        /* è¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠ */
        h2 {
            font-size: 1rem;
            background: #333;
            margin: 0;
            padding: 10px 15px;
            border-left: 5px solid #4dabff;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰è¡¨ç¤º */
        #targetCard {
            width: 100%;
            background: #1f1f1f;
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #444;
        }

        #targetCard img {
            width: 80%;
            max-width: 320px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
        }

        .main-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-top: 15px;
        }

        .main-sub {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 15px;
        }

        /* ãŠã™ã™ã‚ã‚¨ãƒªã‚¢ (2åˆ—) */
        #recommendResults {
            display: flex;
            flex-wrap: wrap;
            padding: 10px;
            justify-content: space-between;
        }

        .card {
            width: 48%;
            background: #272729;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            content-visibility: auto;

        }

        .card img {
            width: 100%;
            height: auto;
            display: block;
        }

        .card-info {
            padding: 10px;
            text-align: center;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
        }

        .card-sub {
            font-size: 0.75rem;
            color: #bbb;
            margin-bottom: 8px;
        }

        /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
        .palette-bar {
            display: flex;
            width: 90%;
            height: 25px;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 auto 5px auto;
            background: #444;
        }

        .color-chip {
            height: 100%;
        }

        .placeholder {
            text-align: center;
            padding: 50px 20px;
            color: #777;
        }

        .reset-btn {
            width: 100%;
            padding: 10px;
            background: none;
            border: none;
            color: #aaa;
            text-decoration: underline;
            font-size: 14px;
            cursor: pointer;
        }

        .card {
            width: 48%;
            background: #272729;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            /* è¿½åŠ ï¼šæŒ‡ãƒãƒ¼ã‚¯ã«ã™ã‚‹ */
            transition: transform 0.2s, background-color 0.2s;
            /* è¿½åŠ ï¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }

        .card:active {
            transform: scale(0.95);
            /* è¿½åŠ ï¼šã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã«å°‘ã—å‡¹ã‚€æ¼”å‡º */
            background-color: #3a3a3c;
        }
    </style>
</head>

<body>

    <h1>é¡ä¼¼ãƒãƒ³ãƒ›ãƒ¼ãƒ«æ¤œç´¢</h1>

    <div class="selector-area">
        <label>éƒ½é“åºœçœŒ</label>
        <select id="prefSelect"></select>

        <label>å¼¾æ•°</label>
        <select id="editionSelect"></select>

        <label>å¯¾è±¡ã®ã‚«ãƒ¼ãƒ‰</label>
        <select id="citySelect"></select>

        <button class="reset-btn" onclick="resetFilters()">æ¡ä»¶ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

        <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 12px; align-items: center;">
            <a href="calender.html" style="
                display: inline-block;
                width: 80%;
                padding: 10px;
                background: #333;
                color: #4dabff;
                text-decoration: none;
                font-size: 14px;
                border: 1px solid #4dabff;
                border-radius: 8px;
                text-align: center;
                font-weight: bold;
            ">ğŸ“… å–å¾—è¨˜éŒ²ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è¦‹ã‚‹</a>

            <a href="index.html" style="color: #888; text-decoration: none; font-size: 13px;">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <div id="targetSection">
        <h2>é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰</h2>
        <div id="targetCardPlaceholder" class="placeholder">ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„</div>
        <div id="targetCard" style="display:none;"></div>
    </div>

    <div id="resultSection">
        <h2>ä¼¼ã¦ã„ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ TOP10</h2>
        <div id="recommendPlaceholder" class="placeholder">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        <div id="recommendResults"></div>
    </div>

    <script>
        let masterData = [];
        let similarityIndex = {};
        const prefOrder = ["ä¸–ç•Œ", "ãã®ä»–", "åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å®®åŸçœŒ", "ç§‹ç”°çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ", "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ", "æ–°æ½ŸçœŒ", "å¯Œå±±çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ", "é™å²¡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å…µåº«çœŒ", "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "é³¥å–çœŒ", "å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ", "å¾³å³¶çœŒ", "é¦™å·çœŒ", "æ„›åª›çœŒ", "é«˜çŸ¥çœŒ", "ç¦å²¡çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ", "ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "å®®å´ç¸£", "é¹¿å…å³¶ç¸£", "æ²–ç¸„ç¸£"];

        Promise.all([
            fetch('master_data.json').then(res => res.json()),
            fetch('similarity_index.json').then(res => res.json())
        ]).then(([data, index]) => {
            masterData = data;
            similarityIndex = index;
            updateFilters();
        });

        const prefSelect = document.getElementById('prefSelect');
        const editionSelect = document.getElementById('editionSelect');
        const citySelect = document.getElementById('citySelect');

        window.onload = () => {
            // 1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const targetCity = urlParams.get('city');

            if (targetCity) {
                // 2. ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼ˆcitySelectï¼‰ã‹ã‚‰è©²å½“ã™ã‚‹å€¤ã‚’æ¢ã—ã¦ã‚»ãƒƒãƒˆ
                const citySelect = document.getElementById('citySelect');

                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã®ä¸­ã«çµ„ã¿è¾¼ã‚€ã®ãŒç†æƒ³
                const checkDataLoad = setInterval(() => {
                    if (masterData.length > 0) {
                        citySelect.value = targetCity;

                        // 3. å€¤ãŒå¤‰ã‚ã£ãŸã“ã¨ã‚’é€šçŸ¥ã—ã¦æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç™ºç«ã•ã›ã‚‹
                        citySelect.dispatchEvent(new Event('change'));

                        clearInterval(checkDataLoad);
                    }
                }, 100);
            }
        };

        function updateFilters() {
            const selectedPref = prefSelect.value;
            const selectedEd = editionSelect.value;

            // éƒ½é“åºœçœŒãƒªã‚¹ãƒˆã®æ›´æ–°ï¼ˆå¼¾æ•°ãƒ•ã‚£ãƒ«ã‚¿è€ƒæ…®ï¼‰
            const rawPrefs = [...new Set(masterData.filter(d => !selectedEd || d.edition === selectedEd).map(d => d.pref))];
            const sortedPrefs = rawPrefs.sort((a, b) => prefOrder.indexOf(a) - prefOrder.indexOf(b));
            updateOptions(prefSelect, sortedPrefs, selectedPref, "ã™ã¹ã¦ã®éƒ½é“åºœçœŒ");

            // å¼¾æ•°ãƒªã‚¹ãƒˆã®æ›´æ–°ï¼ˆçœŒãƒ•ã‚£ãƒ«ã‚¿è€ƒæ…®ï¼‰
            const currentEds = [...new Set(masterData.filter(d => !selectedPref || d.pref === selectedPref).map(d => d.edition))].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            updateOptions(editionSelect, currentEds, selectedEd, "ã™ã¹ã¦ã®å¼¾æ•°");

            // éƒ½å¸‚ãƒªã‚¹ãƒˆã®æ›´æ–°
            const filteredCities = masterData.filter(d => (!selectedPref || d.pref === selectedPref) && (!selectedEd || d.edition === selectedEd));
            citySelect.innerHTML = '<option value="">ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            filteredCities.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.city;
                opt.textContent = `${item.city} (${item.edition})`;
                citySelect.appendChild(opt);
            });
        }

        function updateOptions(el, list, curr, def) {
            el.innerHTML = `<option value="">${def}</option>`;
            list.forEach(v => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = v;
                if (v === curr) opt.selected = true;
                el.appendChild(opt);
            });
        }

        function resetFilters() {
            prefSelect.value = ""; editionSelect.value = "";
            updateFilters();
            document.getElementById('targetCard').style.display = 'none';
            document.getElementById('targetCardPlaceholder').style.display = 'block';
            document.getElementById('recommendResults').innerHTML = '';
            document.getElementById('recommendPlaceholder').style.display = 'block';
        }

        function createPaletteHTML(palette) {
            if (!palette || palette.length === 0) return '';
            const chips = palette.map(c => `<div class="color-chip" style="background:${c.hex}; width:${c.ratio}%"></div>`).join('');
            return `<div class="palette-bar">${chips}</div>`;
        }

        prefSelect.onchange = updateFilters;
        editionSelect.onchange = updateFilters;

        citySelect.onchange = () => {
            const selectedId = citySelect.value;
            if (!selectedId) return;
            const targetData = masterData.find(item => item.city === selectedId);
            const similarIds = (similarityIndex[selectedId + ".png"] || []).slice(0, 10);

            // ãƒ¡ã‚¤ãƒ³è¡¨ç¤º
            document.getElementById('targetCardPlaceholder').style.display = 'none';
            const targetDiv = document.getElementById('targetCard');
            targetDiv.style.display = 'block';
            targetDiv.innerHTML = `
                <img src="${targetData.url}">
                <div class="main-title">${targetData.city}</div>
                <div class="main-sub">${targetData.pref} / ${targetData.edition}</div>
                ${createPaletteHTML(targetData.palette)}
            `;

            // ãŠã™ã™ã‚è¡¨ç¤º
            document.getElementById('recommendPlaceholder').style.display = 'none';
            const resultDiv = document.getElementById('recommendResults');
            resultDiv.innerHTML = '';
            similarIds.forEach(idWithExt => {
                const cityName = idWithExt.replace('.png', '');
                const d = masterData.find(item => item.city === cityName);
                if (d) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <img src="${d.url}">
                        <div class="card-info">
                            <div class="card-title">${d.city}</div>
                            <div class="card-sub">${d.pref}</div>
                            ${createPaletteHTML(d.palette)}
                        </div>`;
                    resultDiv.appendChild(card);
                }
            });
            targetDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        // --- å¤‰æ›´ç‚¹ï¼šã‚«ãƒ¼ãƒ‰ç”Ÿæˆéƒ¨åˆ†ã« onclick ã‚’è¿½åŠ  ---
        function createCardElement(d) {
            const card = document.createElement('div');
            card.className = 'card';
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã« selectCard é–¢æ•°ã‚’å‘¼ã¶ã‚ˆã†ã«è¨­å®š
            card.onclick = () => selectCard(d.city);
            card.innerHTML = `
        <img src="${d.url}">
        <div class="card-info">
            <div class="card-title">${d.city}</div>
            <div class="card-sub">${d.pref}</div>
            ${createPaletteHTML(d.palette)}
        </div>`;
            return card;
        }

        // --- æ–°æ©Ÿèƒ½ï¼šã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦å†æ¤œç´¢ã™ã‚‹é–¢æ•° ---
        function selectCard(cityName) {
            // 1. ãƒ•ã‚£ãƒ«ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã¾ãŸã¯ãã®éƒ½å¸‚ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´ï¼‰
            // ä¸€ç•ªç¢ºå®Ÿãªã®ã¯ã€ä¸€æ—¦ã™ã¹ã¦ã®éƒ½å¸‚ã‚’é¸æŠè‚¢ã«å‡ºã—ã¦ã‹ã‚‰é¸ã¶ã“ã¨
            resetFilters();

            // 2. ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å€¤ã‚’æ›¸ãæ›ãˆ
            citySelect.value = cityName;

            // 3. changeã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•ã§å®Ÿè¡Œ
            citySelect.dispatchEvent(new Event('change'));

            // 4. ç”»é¢ä¸Šéƒ¨ï¼ˆãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ï¼‰ã¸ã‚¹ãƒ ãƒ¼ã‚ºã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- æ—¢å­˜ã® citySelect.onchange å†…ã®ã‚«ãƒ¼ãƒ‰ç”Ÿæˆéƒ¨åˆ†ã‚’å·®ã—æ›¿ãˆ ---
        citySelect.onchange = () => {
            const selectedId = citySelect.value;
            if (!selectedId) return;
            const targetData = masterData.find(item => item.city === selectedId);
            const similarIds = (similarityIndex[selectedId + ".png"] || []).slice(0, 10);

            // ãƒ¡ã‚¤ãƒ³è¡¨ç¤º
            document.getElementById('targetCardPlaceholder').style.display = 'none';
            const targetDiv = document.getElementById('targetCard');
            targetDiv.style.display = 'block';
            targetDiv.innerHTML = `
        <img src="${targetData.url}">
        <div class="main-title">${targetData.city}</div>
        <div class="main-sub">${targetData.pref} / ${targetData.edition}</div>
        ${createPaletteHTML(targetData.palette)}
    `;

            // ãŠã™ã™ã‚è¡¨ç¤º
            document.getElementById('recommendPlaceholder').style.display = 'none';
            const resultDiv = document.getElementById('recommendResults');
            resultDiv.innerHTML = '';

            similarIds.forEach(idWithExt => {
                const cityName = idWithExt.replace('.png', '');
                const d = masterData.find(item => item.city === cityName);
                if (d) {
                    // ã“ã“ã§å…±é€šåŒ–ã—ãŸé–¢æ•°ã‚’ä½¿ç”¨
                    const cardElement = createCardElement(d);
                    resultDiv.appendChild(cardElement);
                }
            });
        };
    </script>
</body>

</html>