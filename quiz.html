<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>マンホール蓋クイズ Mobile</title>
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --bg-color: #000;
            /* より引き締まる純黒 */
        }

        body {
            font-family: -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            color: #eee;
            overflow-x: hidden;
            -webkit-user-select: none;
        }

        /* スコアエリアをコンパクトに上部固定 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .score-box {
            text-align: center;
        }

        .score-label {
            font-size: 10px;
            color: #888;
        }

        .score-val {
            font-size: 1.2rem;
            font-weight: 900;
        }

        #currentScore {
            color: var(--primary-color);
        }

        #bestScore {
            color: #f1c40f;
        }

        /* メインコンテンツ：余白を極限まで削る */
        .quiz-container {
            padding: 10px;
            box-sizing: border-box;
        }

        /* 画像エリア：画面幅いっぱいに近く */
        .crop-area {
            width: 100%;
            aspect-ratio: 1 / 1;
            max-width: 350px;
            /* 大きすぎ防止 */
            margin: 0 auto 10px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--primary-color);
            background: #111;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
        }

        .crop-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #result-message {
            text-align: center;
            height: 1.2em;
            font-size: 1.4rem;
            font-weight: 900;
            margin-bottom: 10px;
        }

        /* 10択ボタン：グリッドを最適化 */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        button.choice {
            height: 48px;
            /* 親指サイズ */
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 8px;
            border: 1px solid #333;
            background: #222;
            color: #fff;
            padding: 0 4px;
            -webkit-tap-highlight-color: transparent;
        }

        button.choice:active {
            background: #444;
        }

        button.correct {
            background: var(--success-color) !important;
            border-color: transparent;
        }

        button.wrong {
            background: var(--danger-color) !important;
            border-color: transparent;
        }

        /* 次へボタン：押しやすく巨大に */
        .next-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 100%;
            height: 60px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 12px;
            margin-top: 10px;
            display: none;
        }

        /* 正解パネル：画像と情報を横並びに近くして高さを節約 */
        .info-panel {
            margin-top: 15px;
            padding: 12px;
            background: #1a1a1a;
            border-radius: 12px;
            display: none;
            border: 1px solid #333;
        }

        .info-content {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .info-text {
            flex: 1;
        }

        .info-panel img {
            width: 80px;
            height: auto;
            border-radius: 4px;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-4px);
            }

            75% {
                transform: translateX(4px);
            }
        }

        .wrong-shake {
            animation: shake 0.15s ease-in-out 2;
        }
    </style>
</head>

<body>

    <div class="header">
        <div class="score-box">
            <div class="score-label">COMBO</div>
            <div class="score-val" id="currentScore">0</div>
        </div>
        <div style="font-weight: bold; font-size: 0.9rem; color: #888;">MANHOLE QUIZ</div>
        <div class="score-box">
            <div class="score-label">BEST</div>
            <div class="score-val" id="bestScore">0</div>
        </div>
    </div>

    <div class="quiz-container">
        <div class="crop-area">
            <img id="quizImage" src="" alt="">
        </div>

        <div id="result-message"></div>

        <div id="options" class="options-grid"></div>

        <button id="nextBtn" class="next-btn" onclick="startQuiz()">NEXT ➔</button>

        <div id="answerInfo" class="info-panel">
            <div class="info-content">
                <div class="info-text">
                    <div style="color: var(--success-color); font-size: 10px; font-weight: bold;">正解のカード</div>
                    <div id="correctCity" style="font-size: 1.1rem; font-weight: bold;"></div>
                    <div id="locationInfo" style="font-size: 0.8rem; color: #888;"></div>
                </div>
                <img id="originalCard" src="">
            </div>
        </div>
    </div>

    <script>
        let masterData = [];
        const CROP_DIR = "manhole_crops/";
        let score = 0;
        let bestScore = localStorage.getItem('manholeBestScore') || 0;
        document.getElementById('bestScore').textContent = bestScore;

        fetch('master_data.json')
            .then(res => res.json())
            .then(data => {
                masterData = data;
                startQuiz();
            });

        function startQuiz() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('result-message').textContent = "";
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('answerInfo').style.display = 'none';
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = "";
            optionsDiv.style.display = 'grid'; // 復活

            const correctData = masterData[Math.floor(Math.random() * masterData.length)];
            document.getElementById('quizImage').src = `${CROP_DIR}${correctData.city}.png`;

            let dummyData = masterData.filter(d => d.city !== correctData.city);
            let choices = [correctData];
            for (let i = 0; i < 9; i++) {
                if (dummyData.length > 0) {
                    const idx = Math.floor(Math.random() * dummyData.length);
                    choices.push(dummyData.splice(idx, 1)[0]);
                }
            }
            choices.sort(() => Math.random() - 0.5);

            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice';
                btn.textContent = choice.city;
                btn.onclick = () => checkAnswer(btn, choice.city, correctData);
                optionsDiv.appendChild(btn);
            });
        }

        function checkAnswer(selectedBtn, selectedCity, correctData) {
            const buttons = document.querySelectorAll('#options button');
            buttons.forEach(btn => btn.disabled = true);
            const msg = document.getElementById('result-message');

            if (selectedCity === correctData.city) {
                score++;
                msg.textContent = "CORRECT!";
                msg.style.color = "var(--success-color)";
                selectedBtn.classList.add('correct');
            } else {
                score = 0;
                msg.textContent = "WRONG...";
                msg.style.color = "var(--danger-color)";
                selectedBtn.classList.add('wrong');
                selectedBtn.classList.add('wrong-shake');
                buttons.forEach(btn => {
                    if (btn.textContent === correctData.city) btn.classList.add('correct');
                });
            }

            document.getElementById('currentScore').textContent = score;
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('manholeBestScore', bestScore);
                document.getElementById('bestScore').textContent = bestScore;
            }

            document.getElementById('correctCity').textContent = correctData.city;
            document.getElementById('locationInfo').textContent = `${correctData.pref} / ${correctData.edition}`;
            document.getElementById('originalCard').src = correctData.url;

            // 操作性アップ：正解後は選択肢を隠して結果を見やすくする
            document.getElementById('options').style.display = 'none';
            document.getElementById('answerInfo').style.display = 'block';
            document.getElementById('nextBtn').style.display = 'block';
        }
    </script>
</body>

</html>