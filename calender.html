<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>取得カレンダー - マンホール図鑑</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --card-bg: #2a2a2a;
            --accent: #4dabff;
            --text: #eee;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: sans-serif;
            margin: 0;
            padding: 15px;
        }

        .nav {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: #444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 14px;
        }

        /* カレンダー本体のスタイル */
        .calendar-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .cal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .day-label {
            font-size: 12px;
            color: #888;
            padding-bottom: 5px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            position: relative;
            transition: 0.2s;
        }

        .day:hover {
            background: #444;
        }

        /* 記録がある日の強調 */
        .has-record {
            border: 2px solid var(--accent);
            font-weight: bold;
            color: var(--accent);
        }

        .selected-day {
            background: var(--accent) !important;
            color: white !important;
        }

        /* 下部に並ぶカードリスト */
        #resultArea {
            margin-top: 25px;
        }

        .result-title {
            font-size: 16px;
            border-left: 4px solid var(--accent);
            padding-left: 10px;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .card-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        /* カードの見切れを防止 */
        .card-mini img {
            width: 100%;
            aspect-ratio: 2/3;
            /* マンホールカードの比率に合わせる */
            object-fit: contain;
            /* 全体が入るように調整 */
            background: #000;
        }

        /* モーダルのスタイル（index.htmlから移植） */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        /* モーダルの箱：少し縦に余裕を持たせる */
        .modal-content {
            background: #2a2a2a;
            padding: 30px 20px 20px;
            /* 上の余白を30pxに増やしてボタン位置を確保 */
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
            box-sizing: border-box;
        }

        /* ×ボタン：画像に被らないよう、絶対配置で右上に固定 */
        .close-btn {
            position: absolute;
            top: 5px;
            /* 上端からの距離 */
            right: 10px;
            /* 右端からの距離 */
            font-size: 28px;
            cursor: pointer;
            color: #bbb;
            z-index: 1010;
            /* 画像より上に表示 */
            padding: 5px;
            /* タップしやすくする */
        }

        /* 画像：ボタンに被らないようマージンを調整 */
        #modalImg {
            width: 100%;
            max-height: 60vh;
            /* スマホで画面からはみ出さないよう高さを制限 */
            object-fit: contain;
            border-radius: 10px;
            margin-top: 10px;
            /* ボタンとの間に隙間を作る */
            margin-bottom: 15px;
        }

        /* カード全体の枠組みをスリムに */
        .card-mini {
            background: var(--card-bg);
            border-radius: 6px;
            /* 少し角を丸める */
            overflow: hidden;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
        }

        /* カードリストのグリッドを少し余裕のあるサイズに */
        .card-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            /* 85pxから90pxへ微増 */
            gap: 10px;
        }

        /* 文字エリアの設定 */
        .card-mini-info {
            padding: 6px 4px;
            /* 上下に少し余裕を持たせる */
            background: #222;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* 中央寄せ */
            min-height: 20px;
            /* 高さを確保してガタつきを抑える */
        }

        /* 都市名のテキストスタイル */
        .card-mini-info div {
            font-size: 11px;
            /* 10pxから11pxへ。視認性を確保 */
            line-height: 1.3;
            text-align: center;
            /* 文字自体を中央寄せ */
            width: 100%;
            /* 幅いっぱい使って中央判定を安定させる */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #eee;
            /* 少しだけ明るくして読みやすく */
            font-weight: 500;
            /* 細すぎず太すぎない中間の太さ */
        }

        /* 枚数に応じた色の変化（ヒートマップ風） */
        .day.level-1 {
            background: rgba(77, 171, 255, 0.3);
            border: 1px solid var(--accent);
        }

        .day.level-2 {
            background: rgba(77, 171, 255, 0.6);
            border: 1px solid var(--accent);
            color: #fff;
        }

        .day.level-3 {
            background: rgba(77, 171, 255, 1.0);
            border: 1px solid var(--accent);
            color: #fff;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(77, 171, 255, 0.5);
        }

        /* 月間合計の表示スタイル */
        .monthly-stats {
            text-align: right;
            font-size: 13px;
            color: #888;
            margin: -10px 5px 10px 0;
        }

        .monthly-stats b {
            color: var(--accent);
            font-size: 16px;
        }
    </style>
</head>

<body>

    <div class="nav">
        <a href="collection.html" class="back-btn">← 図鑑に戻る</a>
        <!-- <div id="currentMonthDisplay" style="font-weight: bold;">2024年 1月</div> -->
    </div>

    <div class="calendar-container">
        <div class="cal-header">
            <button onclick="changeMonth(-1)"
                style="background:none; border:none; color:white; cursor:pointer;">◀</button>
            <div id="monthYear"></div>
            <button onclick="changeMonth(1)"
                style="background:none; border:none; color:white; cursor:pointer;">▶</button>
        </div>
        <div id="monthlyTotal" class="monthly-stats"></div>
        <div class="cal-grid" id="calendarGrid">
        </div>
    </div>

    <div id="resultArea">
        <div id="selectedDateTitle" class="result-title">日付を選択してください</div>
        <div id="cardList" class="card-list"></div>
    </div>

    <div id="modal" class="modal-overlay" onclick="if(event.target==this)closeModal()">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <img id="modalImg" src="" alt="">
            <h3 id="modalTitle" style="margin:10px 0 5px;"></h3>
            <p id="modalSub" style="color:#888; font-size:12px; margin-bottom:15px;"></p>
            <div id="modalMemo"
                style="background:#1a1a1a; padding:15px; border-radius:8px; text-align:left; font-size:14px; color:#ddd; line-height:1.6;">
            </div>
            <div id="modalDate" style="margin-top:10px; font-size:12px; color:var(--accent);"></div>
        </div>
    </div>

    <script>
        let masterData = [];
        let userStats = JSON.parse(localStorage.getItem('manhole_collection')) || {};
        let currentDisplayDate = new Date();

        // 初期読み込み
        async function init() {
            try {
                const res = await fetch('master_data.json');
                if (!res.ok) throw new Error("JSON読み込み失敗");
                masterData = await res.json();
                renderCalendar();
            } catch (e) {
                console.error(e);
                alert("データの読み込みに失敗しました。");
            }
        }

        init();

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthYearDisplay = document.getElementById('monthYear');
            const totalDisplay = document.getElementById('monthlyTotal'); // ★追加
            grid.innerHTML = '';

            const year = currentDisplayDate.getFullYear();
            const month = currentDisplayDate.getMonth();
            monthYearDisplay.textContent = `${year}年 ${month + 1}月`;

            // --- 曜日表示はそのまま ---
            ['日', '月', '火', '水', '木', '金', '土'].forEach(d => {
                grid.innerHTML += `<div class="day-label">${d}</div>`;
            });

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

            let monthTotalCount = 0; // ★月間合計用

            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;

                // ★ その日の取得枚数をカウント
                const dayCards = Object.values(userStats).filter(stat =>
                    stat.collected && stat.date === dateStr
                );
                const count = dayCards.length;
                monthTotalCount += count; // 月間合計に加算

                // ★ 枚数に応じてクラスを決定
                let levelClass = '';
                if (count >= 6) levelClass = 'level-3';
                else if (count >= 3) levelClass = 'level-2';
                else if (count >= 1) levelClass = 'level-1';

                const dayEl = document.createElement('div');
                dayEl.className = `day ${levelClass}`;
                dayEl.textContent = date;
                dayEl.onclick = () => showCardsForDate(dateStr, dayEl);
                grid.appendChild(dayEl);
            }

            // ★ 月間合計を表示
            totalDisplay.innerHTML = `今月の取得数: <b>${monthTotalCount}</b> 枚`;
        }

        function showCardsForDate(dateStr, element) {
            document.querySelectorAll('.day').forEach(d => d.classList.remove('selected-day'));
            element.classList.add('selected-day');

            const title = document.getElementById('selectedDateTitle');
            const list = document.getElementById('cardList');
            list.innerHTML = '';

            const [y, m, d] = dateStr.split('-');
            title.textContent = `${y}年${m}月${d}日 の取得`;

            // 日付に一致するキーを取得
            const targetKeys = Object.keys(userStats).filter(key => {
                return userStats[key].collected && userStats[key].date === dateStr;
            });

            // masterDataからカードを特定
            const cardsOnThisDay = masterData.filter(card => {
                const fullKey = `${card.city} (${card.id})`;
                return targetKeys.some(tKey => tKey === fullKey || tKey.includes(card.city));
            });

            if (cardsOnThisDay.length === 0) {
                list.innerHTML = '<div class="empty-msg">記録はありません</div>';
                return;
            }

            // ★ ここで onclick="openDetail(...)" を含むHTMLを生成
            cardsOnThisDay.forEach(card => {
                const matchedKey = targetKeys.find(tKey => tKey.includes(card.city)) || "";

                list.innerHTML += `
            <div class="card-mini" onclick="openDetail('${card.id}', '${matchedKey}')" style="cursor:pointer;">
                <img src="${card.url}" alt="${card.city}">
                <div class="card-mini-info">
                    <div>${card.city}</div>
                </div>
            </div>
            `;
            });
        }

        function openDetail(cardId, matchedKey) {
            const card = masterData.find(c => c.id === cardId);
            const stat = userStats[matchedKey];
            if (!card || !stat) return;

            document.getElementById('modalImg').src = card.url;
            document.getElementById('modalTitle').textContent = card.city;
            document.getElementById('modalSub').textContent = `${card.pref} / ${card.edition}`;
            document.getElementById('modalMemo').textContent = stat.memo || "（思い出メモはありません）";
            document.getElementById('modalDate').textContent = `取得日: ${stat.date.replace(/-/g, '.')}`;

            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function changeMonth(diff) {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() + diff);
            renderCalendar();
        }
    </script>


</body>

</html>